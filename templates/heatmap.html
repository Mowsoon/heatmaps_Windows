<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WiFi Heatmap</title>
  <link rel="stylesheet" href="/static/home.css">
  <link rel="stylesheet" href="/static/plans.css">
  <link rel="stylesheet" href="/static/heatmap.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/heatmapjs@2.0.5/heatmap.min.js"></script>
</head>

<body>
  <header class="plans-header">
    <div class="go-back">
      <a href="/" class="go-back-button">{{ translations.header.button }}</a>
    </div>
    <div class="container">
      <h1>WiFi Heatmap</h1>
      <p class="tagline">{{ translations.header.tagline }}</p>
    </div>
    <div class="language-selector">
      {% if current_lang == 'fr' %}
        <a href="/change_language/en?next={{ ('/maps/' ~ map_name)|urlencode }}" class="lang-button lang-button-en">EN</a>
      {% else %}
        <a href="/change_language/fr?next={{ ('/maps/' ~ map_name)|urlencode }}" class="lang-button lang-button-fr">FR</a>
      {% endif %}

    </div>
  </header>

  <section class="heatmap">
    <div class="map-container">
      <div class="checklist">
        <h2>{{ translations.checklist.title }}</h2>
        <div class="heatmap-mode-switch">
          <button id="toggleModeBtn" type="button">üîÅ Switch to Channel Mode</button>
        </div>
        <div class="checklist-scroll">
          <form id="heatmapChecklist">
            {% for item in ssid_band_list %}
            <div class="checkbox-item">
                <label>
                    <input type="radio" name="heatmap" value="{{ item }}">
                    {{ item }}
                </label>
            </div>
            {% endfor %}
          </form>
        </div>
        
      </div>
      <div class="map-display">
        <div class="map-wrapper">
          <img id="mapImage" src="{{ map_url }}" alt="{{ map_name }}">
          <div id="heatmapInfo" class="heatmap-info"></div>
        </div>
      </div>      
    </div>
  </section>

  <footer>
    <div class="container">
      <p>{{ translations.footer.copyright }}</p>
    </div>
  </footer>
  
  <script>
    const mapName = "{{ map_name }}";
    const ssidBandList = {{ ssid_band_list | tojson }};
    const channelList = {{ channel_list | tojson }};
  </script>
  

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const checklist = document.getElementById("heatmapChecklist");
      const toggleBtn = document.getElementById("toggleModeBtn");
      const img = document.getElementById("mapImage");
      const infoBox = document.getElementById("heatmapInfo");
      let circles = [];
      let currentMode = "signal";

      function renderChecklist() {
        checklist.innerHTML = "";
        const list = currentMode === "signal" ? ssidBandList : channelList;
        list.forEach(item => {
          const div = document.createElement("div");
          div.className = "checkbox-item";
          div.innerHTML = `
            <label>
              <input type="radio" name="heatmap" value="${item}">
              ${item}
            </label>
          `;
          checklist.appendChild(div);
        });
      }

      toggleBtn.addEventListener("click", () => {
        currentMode = currentMode === "signal" ? "channel" : "signal";
        toggleBtn.textContent = currentMode === "signal"
          ? "üîÅ Switch to Channel Mode"
          : "üîÅ Switch to Signal Mode";
        renderChecklist();
        infoBox.innerText = "";
        circles = [];
        img.onmousemove = null;
        img.onmouseleave = null;
      });

      checklist.addEventListener("change", async (e) => {
        if (e.target.name !== "heatmap") return;
        const selectedKey = encodeURIComponent(e.target.value);
        const modePath = currentMode === "signal" ? "signal" : "channel";
        const url = `/maps/${encodeURIComponent(mapName)}/${modePath}/${selectedKey}`;

        try {
          const response = await fetch(url);
          const result = await response.json();
          if (result.url) {
            img.src = result.url + "?t=" + new Date().getTime();
            circles = currentMode === "signal" ? result.points || [] : [];
            if (currentMode === "signal") {
              img.onmousemove = (e) => {
                const rect = img.getBoundingClientRect();
                const scaleX = img.naturalWidth / rect.width;
                const scaleY = img.naturalHeight / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                const radius = 30;
                const point = circles.find(p => {
                  const dx = p.x - x;
                  const dy = p.y - y;
                  return dx * dx + dy * dy < radius * radius;
                });
                infoBox.innerText = point
                  ? `Signal: ${point.signal} dBm\nBSSID: ${point.bssid}`
                  : "";
              };
              img.onmouseleave = () => infoBox.innerText = "";
            } else {
              img.onmousemove = null;
              img.onmouseleave = null;
              infoBox.innerText = "";
            }
          } else {
            console.error("Erreur : ", result.error);
          }
        } catch (err) {
          console.error("Erreur chargement image heatmap :", err);
        }
      });
      renderChecklist();
    });
  </script>
  </body>
</html>
