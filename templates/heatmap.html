<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WiFi Heatmap</title>
  <link rel="stylesheet" href="/static/home.css">
  <link rel="stylesheet" href="/static/plans.css">
  <link rel="stylesheet" href="/static/heatmap.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/heatmapjs@2.0.5/heatmap.min.js"></script>
</head>

<body>
  <header class="plans-header">
    <div class="go-back">
      <a href="/" class="go-back-button">{{ translations.header.button }}</a>
    </div>
    <div class="container">
      <h1>WiFi Heatmap</h1>
      <p class="tagline">{{ translations.header.tagline }}</p>
    </div>
    <div class="language-selector">
      {% if current_lang == 'fr' %}
        <a href="/change_language/en?next={{ ('/maps/' ~ map_name)|urlencode }}" class="lang-button lang-button-en">EN</a>
      {% else %}
        <a href="/change_language/fr?next={{ ('/maps/' ~ map_name)|urlencode }}" class="lang-button lang-button-fr">FR</a>
      {% endif %}

    </div>
  </header>

  <section class="heatmap">
    <div class="map-container">
      <div class="checklist">
        <h2>{{ translations.checklist.title }}</h2>
        <div class="checklist-scroll">
          <form id="heatmapChecklist">
            {% for item in ssid_band_list %}
            <div class="checkbox-item">
                <label>
                    <input type="radio" name="heatmap" value="{{ item }}">
                    {{ item }}
                </label>
            </div>
            {% endfor %}
          </form>
        </div>
        
      </div>
      <div class="map-display">
        <div class="map-wrapper">
          <img id="mapImage" src="{{ map_url }}" alt="{{ map_name }}">
          <div id="heatmapInfo" class="heatmap-info"></div>
        </div>
      </div>      
    </div>
  </section>

  <footer>
    <div class="container">
      <p>{{ translations.footer.copyright }}</p>
    </div>
  </footer>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const checklist = document.getElementById("heatmapChecklist");
      const img = document.getElementById("mapImage");
      const infoBox = document.getElementById("heatmapInfo");
      let circles = [];
  
      checklist.addEventListener("change", async (e) => {
        if (e.target.name !== "heatmap") return;
  
        const selectedKey = encodeURIComponent(e.target.value);
        const mapName = "{{ map_name }}";
        const url = `/maps/${encodeURIComponent(mapName)}/data/${selectedKey}`;
  
        try {
          const response = await fetch(url);
          const result = await response.json();
          if (result.url) {
            img.src = result.url + "?t=" + new Date().getTime();
            circles = result.points || [];
  
            img.onload = () => {
              img.addEventListener("mousemove", (e) => {
                const rect = img.getBoundingClientRect();
                const scaleX = img.naturalWidth / rect.width;
                const scaleY = img.naturalHeight / rect.height;
  
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
  
                const radius = 30;
                const point = circles.find(p => {
                  const dx = p.x - x;
                  const dy = p.y - y;
                  return dx * dx + dy * dy < radius * radius;
                });
  
                if (point) {
                  infoBox.innerText = `Signal: ${point.signal} dBm\nBSSID: ${point.bssid}`;
                } else {
                  infoBox.innerText = "";
                }
              });
  
              img.addEventListener("mouseleave", () => {
                infoBox.innerText = "";
              });
            };
          } else {
            console.error("Erreur : ", result.error);
          }
        } catch (err) {
          console.error("Erreur chargement image heatmap :", err);
        }
      });
    });
  </script>  
  </body>
</html>
